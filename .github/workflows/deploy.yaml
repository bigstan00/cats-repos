name: Deploy Cats App to Minikube

on:
  push:
    branches: [master]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      revision:
        description: 'Deployment revision number for rollback'
        required: false
        type: number
        default: 0

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.revision && format('deploy-{0}', github.event.inputs.revision) || github.ref }}

    - name: Verify required files
      run: |
        echo "ğŸ” Checking repository structure..."
        ls -la
        if [ ! -f "Dockerfile" ]; then
          echo "::error::âŒ Dockerfile not found in root directory"
          exit 1
        fi
        if [ ! -d "k8s" ]; then
          echo "::error::âŒ k8s directory not found"
          exit 1
        fi
        echo "âœ… All required files present"
    - name: Set up Minikube
      uses: medyagh/setup-minikube@latest
      with:
        kubernetes-version: '1.28.0'
        driver: docker
        cpus: 4
        memory: 8g
        wait-timeout: 5m

    - name: Start Minikube with required addons
      run: |
        echo "ğŸš€ Starting Minikube cluster..."
        minikube start
        minikube addons enable registry
        minikube addons enable metrics-server
        minikube status
    - name: Configure Docker environment
      run: |
        echo "ğŸ³ Configuring Docker to use Minikube's daemon..."
        eval $(minikube -p minikube docker-env)
        docker info | grep "Docker Root Dir"
    - name: Build and push Docker image
      run: |
        eval $(minikube -p minikube docker-env)
        echo "ğŸ—ï¸ Building Docker image..."
        docker build -t cats-app:${{ github.sha }} .
        docker tag cats-app:${{ github.sha }} localhost:5000/cats-app:${{ github.sha }}
        docker push localhost:5000/cats-app:${{ github.sha }}
        echo "âœ… Image built and pushed: localhost:5000/cats-app:${{ github.sha }}"
    - name: Deploy Kubernetes resources
      run: |
        echo "âš™ï¸ Applying Kubernetes manifests..."
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/svc.yaml
        kubectl apply -f k8s/hpa.yaml
        kubectl apply -f k8s/pdb.yaml
        echo "ğŸ”„ Updating deployment image..."
        kubectl set image deployment/cats-app cats-app=localhost:5000/cats-app:${{ github.sha }} --record
        kubectl rollout status deployment/cats-app --timeout=300s
        echo "âœ… Deployment complete"

    - name: Install Prometheus Stack
      if: always()
      run: |
        echo "ğŸ“Š Setting up Prometheus monitoring..."
        kubectl create namespace monitoring || true
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          -n monitoring \
          --set grafana.enabled=false \
          --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
          --wait

    - name: Apply ServiceMonitor
      run: |
        echo "ğŸ”­ Applying ServiceMonitor for cats-app..."
        kubectl apply -f k8s/k8s/prometheus-monitor.yaml
        sleep 10  # Wait for discovery

    - name: Verify Prometheus Integration
      run: |
        echo "ğŸ”„ Waiting for Prometheus to be ready..."
        kubectl -n monitoring wait --for=condition=available deployment/prometheus-kube-prometheus-operator --timeout=120s
        
        echo "ğŸ“¡ Verifying metrics collection..."
        kubectl port-forward svc/prometheus-kube-prometheus-prometheus 9090 -n monitoring &
        sleep 5  # Allow port-forward to establish
        
        # Check if cats-app is being scraped
        if ! curl -s "http://localhost:9090/api/v1/targets" | jq -e '.data.activeTargets[] | select(.labels.job=="cats-app" and .health=="up")'; then
          echo "::error::Prometheus is not scraping cats-app metrics"
          echo "Debug info:"
          kubectl -n monitoring get servicemonitors
          kubectl describe servicemonitor cats-app-monitor -n monitoring
          exit 1
        fi
        
        # Verify metrics endpoint
        SERVICE_URL=$(minikube service cats-service --url)
        if ! curl -s "$SERVICE_URL/metrics" | grep -q "http_requests_total"; then
          echo "::error::Metrics endpoint not returning expected data"
          exit 1
        fi
        
        echo "âœ… Prometheus integration verified"
    
    - name: Verify deployment
      run: |
        echo "ğŸ“Š Deployment status:"
        kubectl get deployments -o wide
        echo ""
        echo "ğŸ³ Pod status:"
        kubectl get pods -o wide --selector=app=cats-app
        echo ""
        echo "ğŸ”Œ Service status:"
        kubectl get svc cats-service -o wide
        echo ""
        echo "ğŸŒ Access URLs:"
        minikube service cats-service --url || echo "::warning::Service URL not available"
        echo ""
        echo "ğŸ“ˆ Horizontal Pod Autoscaler status:"
        kubectl get hpa -o wide || true
    - name: Rollback if requested
      if: ${{ github.event.inputs.revision != 0 }}
      run: |
        echo "âª Starting rollback to revision ${{ github.event.inputs.revision }}"
        if ! kubectl rollout undo deployment/cats-app --to-revision=${{ github.event.inputs.revision }}; then
          echo "::error::Failed to rollback to revision ${{ github.event.inputs.revision }}"
          exit 1
        fi
        
        echo "ğŸ”„ Verifying rollback status..."
        kubectl rollout status deployment/cats-app --timeout=300s
        echo "âœ… Rollback complete"
        
        echo "ğŸ“œ Updated deployment history:"
        kubectl rollout history deployment/cats-app