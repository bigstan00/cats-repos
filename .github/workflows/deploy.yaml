name: Deploy Cats App to Minikube

on:
  push:
    branches: [master]
    tags: ['v*']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify required files
      run: |
        echo "Checking repository structure..."
        ls -la
        if [ ! -f "Dockerfile" ]; then
          echo "❌ Error: Dockerfile not found in root directory"
          exit 1
        fi
        if [ ! -d "k8s" ]; then
          echo "❌ Error: k8s directory not found"
          exit 1
        fi

    - name: Set up Minikube
      uses: medyagh/setup-minikube@latest
      with:
        kubernetes-version: '1.28.0'
        driver: docker
        cpus: 4
        memory: 8g

    - name: Start Minikube with required addons
      run: |
        minikube start
        minikube addons enable registry
        minikube addons enable metrics-server

    - name: Configure Docker environment
      run: |
        echo "Configuring Docker to use Minikube's daemon..."
        eval $(minikube -p minikube docker-env)
        docker info | grep "Docker Root Dir"

    - name: Build and push Docker image
      run: |
        eval $(minikube -p minikube docker-env)
        echo "Building Docker image..."
        docker build -t cats-app:${{ github.sha }} .
        docker tag cats-app:${{ github.sha }} localhost:5000/cats-app:${{ github.sha }}
        docker push localhost:5000/cats-app:${{ github.sha }}

    - name: Deploy Kubernetes resources
      run: |
        echo "Applying Kubernetes manifests from k8s directory..."
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/svc.yaml
        kubectl apply -f k8s/hpa.yaml
        kubectl apply -f k8s/pdb.yaml

        echo "Updating image..."
        kubectl set image deployment/cats-app cats-app=localhost:5000/cats-app:${{ github.sha }} --record
        kubectl rollout status deployment/cats-app --timeout=300s

    - name: Verify deployment
      run: |
        echo "Deployment status:"
        kubectl get deployments -o wide
        echo ""
        echo "Pod status:"
        kubectl get pods -o wide
        echo ""
        echo "Service status:"
        kubectl get svc -o wide
        echo ""
        echo "Access URLs:"
        minikube service cats-service --url
        echo ""
        echo "Horizontal Pod Autoscaler status:"
        kubectl get hpa -o wide || true

    - name: Rollback to revision
      run: |
        echo "Available revisions:"
        kubectl rollout history deployment/cats-app
    
        echo "Rolling back to revision ${{ inputs.revision }}"
        kubectl rollout undo deployment/cats-app --to-revision=${{ inputs.revision }}
        kubectl rollout status deployment/cats-app --timeout=300s